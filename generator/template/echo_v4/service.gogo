// Code generated by protoapi:go; DO NOT EDIT.

package {{.Package}}
{{.Imports}}
{{$s := .}}
import (
	echo "github.com/labstack/echo/v4"
)

// {{.Name}} is the interface contains all the controllers
type {{.Name}} interface {
	{{- if .AuthRequired}}
	{{.Name}}Auth(c echo.Context) (err error)
	{{- end}}
	{{- range .Methods }}

	{{.Title}}(c echo.Context, req {{.InputGoType}}) (resp {{.OutputGoType}}{{if ne .ErrorType ""}}, bizError {{.ErrorGoType}}{{end}}, err error)
	{{- end }}
}

{{- if .AuthRequired}}
func _{{.Name}}Auth_Handler(srv {{.Name}}) echo.MiddlewareFunc {
	return func(next echo.HandlerFunc) echo.HandlerFunc {
		return func(c echo.Context) (err error) {
			err = srv.{{.Name}}Auth(c)

			if err != nil {
				{{- if $s.HasCommonError}}
				// e:= err.({{$s.CommonError}}) will panic if assertion fail, which is not what we want
				if e, ok := err.({{$s.CommonError}}); ok {
					return c.JSON(400, e)
				}
				{{- end}}
				return c.String(500, err.Error())
			}

			return next(c)
		}
	}
}
{{- end}}
{{range .Methods }}
func _{{.Name}}_Handler(srv {{$.Name}}) echo.HandlerFunc {
	return func(c echo.Context) (err error) {
		req := new({{.InputGoTypeName}})

		if err = c.Bind(req); err != nil {
			return c.JSON(500, err)
		}
/*
		{{if $s.HasCommonValidateError}}
		if valErr := req.Validate(); valErr != nil {
			resp := {{$s.CommonErrorPointer}}{ValidateError: valErr}
			return c.JSON(420, resp)
		}
		{{end}}
*/
		resp{{if ne .ErrorType "" }}, bizError{{end}}, err := srv.{{.Title}}(c, req)
		if err != nil {
			{{- if $s.HasCommonError}}
			// e:= err.({{$s.CommonError}}) will panic if assertion fail, which is not what we want
			if e, ok := err.({{$s.CommonError}}); ok {
				return c.JSON(420, e)
			}
			{{- end}}
			return c.String(500, err.Error())
		}

		{{- if ne .ErrorType "" }}
		if bizError != nil {
			return c.JSON(400, bizError)
		}
		{{- end}}

		return c.JSON(200, resp)
	}
}
{{- end }}

// Register{{.Name}} is used to bind routers
func Register{{.Name}}(e *echo.Echo, srv {{.Name}}) {
	Register{{.Name}}WithPrefix(e, srv, "")
}

// Register{{.Name}}WithPrefix is used to bind routers with custom prefix
func Register{{.Name}}WithPrefix(e *echo.Echo, srv {{.Name}}, prefix string) {

	{{- if .AuthRequired}}
	g := e.Group(prefix + "{{.ServicePath}}", _{{.Name}}Auth_Handler(srv))
	{{- end}}

	{{- range .Methods }}
	{{- if ne .ServiceType "POST" }}
	{{- if $s.AuthRequired}}
	g.GET("{{.MethodPath}}", _{{.Name}}_Handler(srv))
	{{- else}}
	e.GET(prefix + "{{.Path}}", _{{.Name}}_Handler(srv))
	{{- end }}
	{{- end }}

	{{- if ne .ServiceType "GET" }}
	{{- if $s.AuthRequired}}
	g.POST("{{.MethodPath}}", _{{.Name}}_Handler(srv))
	{{- else}}
	e.POST(prefix + "{{.Path}}", _{{.Name}}_Handler(srv))
	{{- end }}
	{{- end }}
	{{- end }}
}

